---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { readdir, readFile } from 'fs/promises';
import { join } from 'path';
import { marked } from 'marked';

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), 'src/content/tools');
  const toolFiles = await readdir(toolsDir);

  return toolFiles
    .filter(file => file.endsWith('.md'))
    .map(file => ({
      params: { tool: file.replace('.md', '').toLowerCase() }
    }));
}

const { tool } = Astro.params;

// Read the markdown file
const toolsDir = join(process.cwd(), 'src/content/tools');
const toolFiles = await readdir(toolsDir);
const matchingFile = toolFiles.find(f => f.toLowerCase().replace('.md', '') === tool);

if (!matchingFile) {
  return Astro.redirect('/tools');
}

const filePath = join(toolsDir, matchingFile);
const content = await readFile(filePath, 'utf-8');
const html = marked(content);

// Extract title from first h1 or use filename
const titleMatch = content.match(/^#\s+(.+)$/m);
const title = titleMatch ? titleMatch[1] : matchingFile.replace('.md', '');
---

<BaseLayout title={`${title} - Tools - maenifold`}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-6">
      <a href="/tools" class="text-primary dark:text-primary-light hover:underline">
        ‚Üê Back to Tools
      </a>
    </div>

    <article class="prose prose-lg dark:prose-invert max-w-none">
      <Fragment set:html={html} />
    </article>
  </div>
</BaseLayout>
